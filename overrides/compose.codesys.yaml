services:
  configurator:
    environment:
      CODESYS_HOST: codesys
      CODESYS_PORT: 502
      CODESYS_WEB_PORT: 8080
      CODESYS_PROGRAMMING_PORT: 1217
    depends_on:
      codesys:
        condition: service_healthy

  codesys:
    image: ${CODESYS_IMAGE:-codesys-control-sl:latest}
    ports:
      - "8080"                              # Web interface (auto-generated port)
      - "502:502"                           # Modbus TCP (fixed port for protocol compliance)
      - "1217:1217"                         # CODESYS programming port
    healthcheck:
      test: ["CMD", "pgrep", "-f", "codesyscontrol.bin"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      CODESYS_RUNTIME_PORT: 502
      CODESYS_WEB_PORT: 8080
      CODESYS_PROGRAMMING_PORT: 1217
      CODESYS_LOG_LEVEL: ${CODESYS_LOG_LEVEL:-INFO}
      CODESYS_DEMO_MODE: "true"
    volumes:
      # ARM64 image (jugaadtech) needs specific volume mounts
      # AMD64 image (hilscher) works without volume mounts
      - codesys-data:/data/PlcLogic
    networks:
      - frappe_network
    privileged: true                        # Required for CODESYS Virtual Control SL

volumes:
  codesys-data:

networks:
  frappe_network: {}