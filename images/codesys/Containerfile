# Official CODESYS Control for Linux Docker Container
# Built from genuine CODESYS FTP source
FROM debian:11.6

# Install required packages
RUN apt-get update && \
    apt-get install -y wget sudo unzip libusb-1.0-0-dev procps && \
    rm -rf /var/lib/apt/lists/*

# CODESYS version configuration
ARG CDS_VERSION=4.12.0.0
ARG CODESYS_ARCH=AMD64

# Official CODESYS FTP source URL (from installer network trace)
ENV CODESYS_URL="https://store-archive.codesys.com/ftp_download/3S/VirtualLinuxSL/000138/${CDS_VERSION}/CODESYS%20Virtual%20Control%20for%20Linux%20SL%20${CDS_VERSION}.package"

# Download and install CODESYS Control from official source
RUN wget --output-document=/tmp/codesys.package "${CODESYS_URL}" && \
    unzip -p /tmp/codesys.package '*codemeter*.deb' > /tmp/codemeter.deb && \
    dpkg -i /tmp/codemeter.deb || apt-get install -f -y && \
    unzip -p /tmp/codesys.package '*codesyscontrol*.deb' > /tmp/codesys.deb && \
    dpkg -i /tmp/codesys.deb || apt-get install -f -y && \
    rm -f /tmp/codesys.package /tmp/codemeter.deb /tmp/codesys.deb

# Create codesys user and data directory
RUN useradd -m -s /bin/bash codesys && \
    mkdir -p /var/opt/codesys && \
    chown -R codesys:codesys /var/opt/codesys

# Expose required ports
EXPOSE 502 8080 1217

# Health check for CODESYS runtime
HEALTHCHECK --interval=30s --timeout=10s --retries=3 --start-period=120s \
    CMD pgrep -f "codesyscontrol.bin" || exit 1

# Set working directory
WORKDIR /var/opt/codesys

# Set up environment for CODESYS runtime
ENV LD_LIBRARY_PATH=/opt/codesys/lib:$LD_LIBRARY_PATH

# Start CODESYS Control runtime
USER codesys
CMD ["/opt/codesys/bin/codesyscontrol.bin", "/etc/codesyscontrol/CODESYSControl.cfg"]
